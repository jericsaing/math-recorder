<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Record Sheet in Math</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Track math activities, practices, quizzes, and more">
  <meta name="theme-color" content="#4285f4">
  <link rel="manifest" href="#" id="manifest-placeholder">
  <link rel="icon" type="image/png" href="#" id="icon-placeholder">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Math Records">
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; font-size: 16px; }
    h2 { margin-bottom: 10px; text-align: center; }
    #loginOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #loginOverlay.hidden {
      display: none;
    }
    #loginBox {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
    }
    #loginBox h3 {
      margin-top: 0;
      text-align: center;
      color: #4285f4;
    }
    #loginBox input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }
    #loginBox button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      font-size: 16px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #loginBox button:hover {
      background: #3367d6;
    }
    #loginError {
      color: red;
      text-align: center;
      margin-top: 10px;
      display: none;
    }
    .hidden { display: none; }
    .info-boxes { margin-bottom: 20px; }
    .info-boxes label { display: block; margin-bottom: 4px; font-weight: bold; }
    .info-boxes input { margin-bottom: 12px; padding: 8px; width: 95%; max-width: 400px; font-size: 16px; }
    table { 
      border-collapse: collapse;
      width: 100%;
      min-width: 800px;
    }
    th, td { 
      border: 1px solid #ccc;
      min-width: 60px;
      padding: 0;
    }
    th { 
      background: #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 4px;
    }
    td {
      background: #fff;
    }
    th:nth-child(1), td:nth-child(1) {
      position: sticky;
      left: 0;
      background: #fff;
      z-index: 5;
    }
    th:nth-child(2), td:nth-child(2) {
      position: sticky;
      left: 60px;
      background: #fff;
      z-index: 5;
    }
    th:nth-child(1) {
      background: #f0f0f0;
      z-index: 15;
    }
    th:nth-child(2) {
      background: #f0f0f0;
      z-index: 15;
    }
    input.cell { 
      width: 100%;
      border: none;
      padding: 4px;
      font-size: 15px;
      box-sizing: border-box;
    }
    input.cell:focus { outline: 2px solid dodgerblue; background: #eef6ff; }
    input.cell[readonly] { background: #f3f3f3; color: #555; cursor: default; }
    button { margin-top: 10px; margin-right: 10px; padding: 12px 20px; font-size: 16px; cursor: pointer; }
    #status {
      position: fixed;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 15px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease-out;
      z-index: 999;
    }
    .table-section { margin-bottom: 30px; }
    .table-wrapper { overflow-x: auto; }
    .button-container { margin-top: 10px; }
    
    #installPrompt {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #4285f4;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
      max-width: 300px;
    }
    #installPrompt button {
      background: white;
      color: #4285f4;
      border: none;
      padding: 8px 16px;
      margin: 5px 5px 0 0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    #installPrompt button:hover {
      background: #f0f0f0;
    }
  </style>
</head>

<body>
  <div id="loginOverlay">
    <div id="loginBox">
      <h3>Leader Login</h3>
      <p style="text-align: center; color: #666;">Enter your password to continue</p>
      <input type="password" id="passwordInput" placeholder="Enter password" autocomplete="off">
      <button id="loginBtn">Login</button>
      <div id="loginError">Incorrect password. Please try again.</div>
    </div>
  </div>

  <div id="mainContent" class="hidden">
  <h2>Record Sheet in Math</h2>

  <div id="installPrompt">
    <div style="margin-bottom: 10px;">Install this app for offline access!</div>
    <button id="installBtn">Install</button>
    <button id="dismissBtn">Dismiss</button>
  </div>

  <div class="info-boxes">
    <label for="leaderName">Leader's Name:</label>
    <input type="text" id="leaderName">

    <label for="section">Section:</label>
    <input type="text" id="section">

    <label for="groupNumber">Group Number:</label>
    <input type="text" id="groupNumber">
  </div>

  <div class="table-section">
    <div class="table-wrapper">
      <table id="table1">
        <thead>
          <tr>
            <th>Last Name</th>
            <th>First Name</th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th>
            <th>Activity</th>
          </tr>
        </thead>
        <tbody id="table1-tbody"></tbody>
      </table>
    </div>
    <div class="button-container">
      <button id="saveBtnTable1">Save Activity</button>
      <button id="clearBtnTable1">Clear Activity</button>
    </div>
  </div>

  <div class="table-section">
    <div class="table-wrapper">
      <table id="table2">
        <thead>
          <tr>
            <th>Last Name</th>
            <th>First Name</th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th>
            <th>Practice</th>
          </tr>
        </thead>
        <tbody id="table2-tbody"></tbody>
      </table>
    </div>
    <div class="button-container">
      <button id="saveBtnTable2">Save Practice</button>
      <button id="clearBtnTable2">Clear Practice</button>
    </div>
  </div>

  <div class="table-section">
    <div class="table-wrapper">
      <table id="table3">
        <thead>
          <tr>
            <th>Last Name</th>
            <th>First Name</th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th><input class="cell" value=""></th><th><input class="cell" value=""></th>
            <th>Quiz</th>
            <th>Recitation</th>
            <th>Lessons</th>
            <th>Summative</th>
          </tr>
        </thead>
        <tbody id="table3-tbody"></tbody>
      </table>
    </div>
    <div class="button-container">
      <button id="saveBtnTable3">Save QRLS</button>
      <button id="clearBtnTable3">Clear QRLS</button>
    </div>
  </div>

  <div class="table-section">
    <div class="table-wrapper">
      <table id="table4">
        <thead>
          <tr>
            <th>Last Name</th>
            <th>First Name</th>
            <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
            <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
            <th>11</th><th>12</th><th>13</th><th>14</th><th>15</th>
            <th>16</th><th>17</th><th>18</th><th>19</th><th>20</th>
            <th>21</th><th>22</th><th>23</th><th>24</th><th>25</th>
            <th>26</th><th>27</th><th>28</th><th>29</th><th>30</th>
            <th>31</th><th>32</th><th>33</th><th>34</th><th>35</th>
            <th>Flashcards</th>
          </tr>
        </thead>
        <tbody id="table4-tbody"></tbody>
      </table>
    </div>
    <div class="button-container">
      <button id="saveBtnTable4">Save Flashcards</button>
      <button id="clearBtnTable4">Clear Flashcards</button>
    </div>
  </div>

  <div class="table-section">
    <div class="table-wrapper">
      <table id="table5">
        <thead>
          <tr>
            <th>Last Name</th>
            <th>First Name</th>
            <th>Activity</th>
            <th>Practice</th>
            <th>Quiz</th>
            <th>Recitation</th>
            <th>Lessons</th>
            <th>Summative</th>
            <th>Flashcards</th>
          </tr>
        </thead>
        <tbody id="table5-tbody"></tbody>
      </table>
    </div>
    <div class="button-container">
      <button id="saveBtn">Save All</button>
      <button id="clearAllBtn">Clear All</button>
    </div>
  </div>

  <button id="copyBtn">Copy CSV</button>
  <button id="syncBtn">Sync to Google Sheets</button>
  <div id="status"></div>
  </div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwNcXfQE9fFxPgIYuNsZSjHoY1VsMDpoWzGiLyu3AD0HiclJSduJH8at0Nq9ha-uyPg/exec';

    const PASSWORDS = {
      '1-1': 'password11', '1-2': 'password12', '1-3': 'password13', '1-4': 'password14', '1-5': 'password15',
      '2-1': 'password21', '2-2': 'password22', '2-3': 'password23', '2-4': 'password24', '2-5': 'password25',
      '3-1': 'password31', '3-2': 'password32', '3-3': 'password33', '3-4': 'password34', '3-5': 'password35',
      '4-1': 'password41', '4-2': 'password42', '4-3': 'password43', '4-4': 'password44', '4-5': 'password45',
      '5-1': 'password51', '5-2': 'password52', '5-3': 'password53', '5-4': 'password54', '5-5': 'password55',
      '6-1': 'password61', '6-2': 'password62', '6-3': 'password63', '6-4': 'password64', '6-5': 'password65'
    };

    const manifestData = {
      name: "Math Record Sheet",
      short_name: "Math Records",
      display: "standalone",
      background_color: "#ffffff",
      theme_color: "#4285f4",
      icons: [{
        src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect fill='%234285f4' width='192' height='192' rx='24'/%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-weight='bold'%3Eâˆ‘%3C/text%3E%3C/svg%3E",
        sizes: "192x192", type: "image/svg+xml"
      }]
    };

    const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
    document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(manifestBlob));

    const urlParams = new URLSearchParams(window.location.search);
    const classParam = urlParams.get('class') || '';
    const leaderParam = urlParams.get('leader') || '';
    const loginOverlay = document.getElementById('loginOverlay');
    const mainContent = document.getElementById('mainContent');
    const passwordInput = document.getElementById('passwordInput');
    const leaderKey = `${classParam}-${leaderParam}`;
    const sessionKey = `auth_${leaderKey}`;

    if (sessionStorage.getItem(sessionKey) === 'authenticated') {
      loginOverlay.classList.add('hidden');
      mainContent.classList.remove('hidden');
    }
    
    function checkPassword() {
      if (passwordInput.value === PASSWORDS[leaderKey]) {
        sessionStorage.setItem(sessionKey, 'authenticated');
        loginOverlay.classList.add('hidden');
        mainContent.classList.remove('hidden');
        initialLoad();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    }
    
    document.getElementById('loginBtn').onclick = checkPassword;
    passwordInput.onkeypress = (e) => { if (e.key === 'Enter') checkPassword(); };

    const STORAGE_KEY = classParam && leaderParam ? `math_record_${classParam}_${leaderParam}_v15` : "math_record_sheet_v15";
    
    // UPDATED: Changed from 10 to 15
    const ROW_COUNT = 15;

    const leader = document.getElementById("leaderName");
    const section = document.getElementById("section");
    const group = document.getElementById("groupNumber");
    const table1Tbody = document.getElementById("table1-tbody");
    const table2Tbody = document.getElementById("table2-tbody");
    const table3Tbody = document.getElementById("table3-tbody");
    const table4Tbody = document.getElementById("table4-tbody");
    const table5Tbody = document.getElementById("table5-tbody");
    const table1HeadInputs = document.querySelectorAll("#table1 thead input.cell");
    const table2HeadInputs = document.querySelectorAll("#table2 thead input.cell");
    const table3HeadInputs = document.querySelectorAll("#table3 thead input.cell");

    function renderRow(tbodyElement, columnCount, data = [], readOnlyColumns = []) {
      const tr = document.createElement("tr");
      for (let i = 0; i < columnCount; i++) {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.className = "cell";
        input.value = data[i] || "";
        if (readOnlyColumns.includes(i)) input.readOnly = true;
        td.appendChild(input);
        tr.appendChild(td);
      }
      tbodyElement.appendChild(tr);
    }

    function initialLoad() {
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
      leader.value = saved.leader || (leaderParam ? `Leader ${leaderParam}` : "");
      section.value = saved.section || (classParam ? `Class ${classParam}` : "");
      group.value = saved.group || (leaderParam || "");
      
      const renderTable = (tbody, savedData, columnCount, readOnlyIndices, headerInputs, savedHeaders) => {
        tbody.innerHTML = ''; 
        const dataToRender = (savedData || []).slice(0, ROW_COUNT);
        dataToRender.forEach(r => renderRow(tbody, columnCount, r, readOnlyIndices));
        for (let i = dataToRender.length; i < ROW_COUNT; i++) renderRow(tbody, columnCount, [], readOnlyIndices);
        if(headerInputs && savedHeaders) headerInputs.forEach((input,i)=>input.value=savedHeaders[i]||"");
      };

      renderTable(table1Tbody, saved.table1, 28, [27], table1HeadInputs, saved.table1Headers);
      renderTable(table2Tbody, saved.table2, 28, [27], table2HeadInputs, saved.table2Headers);
      renderTable(table3Tbody, saved.table3, 16, [12], table3HeadInputs, saved.table3Headers);
      renderTable(table4Tbody, saved.table4, 38, [37]);
      renderTable(table5Tbody, saved.table5, 9, [0,1,2,3,4,5,6,7,8]);

      setupFormulas();
      attachAutosaveListeners();
    }

    function debounce(func, timeout = 1500) {
      let timer;
      return (...args) => { clearTimeout(timer); timer = setTimeout(() => { func.apply(this, args); }, timeout); };
    }
    
    function attachAutosaveListeners() {
      const debouncedSaveAll = debounce(saveAll, 1500);
      const inputs = [...document.querySelectorAll("#mainContent input.cell:not([readonly])"), leader, section, group];
      inputs.forEach(input => {
        input.removeEventListener('input', debouncedSaveAll); 
        input.addEventListener('input', debouncedSaveAll);
      });
    }

    function setupFormulas() {
      const t1Rows = table1Tbody.querySelectorAll("tr");
      const t2Rows = table2Tbody.querySelectorAll("tr");
      const t3Rows = table3Tbody.querySelectorAll("tr");
      const t4Rows = table4Tbody.querySelectorAll("tr");
      const t5Rows = table5Tbody.querySelectorAll("tr");

      t1Rows.forEach((row,i)=>{
        const t1In = row.querySelectorAll("input.cell");
        const t2In = t2Rows[i].querySelectorAll("input.cell");
        const t3In = t3Rows[i].querySelectorAll("input.cell");
        const t4In = t4Rows[i].querySelectorAll("input.cell");
        const t5In = t5Rows[i].querySelectorAll("input.cell");

        const recalc = ()=>{
          let actSum=0; for(let j=2;j<=26;j++){const v=parseFloat(t1In[j].value); if(!isNaN(v)) actSum+=v;}
          t1In[27].value=actSum; t5In[2].value=actSum;

          [t2In, t3In, t4In, t5In].forEach(set => { set[0].value=t1In[0].value; set[1].value=t1In[1].value; });

          let prSum=0; for(let j=2;j<=26;j++){const v=parseFloat(t2In[j].value); if(!isNaN(v)) prSum+=v;}
          t2In[27].value=prSum; t5In[3].value=prSum;

          let qSum=0; for(let j=2;j<=11;j++){const v=parseFloat(t3In[j].value); if(!isNaN(v)) qSum+=v;}
          t3In[12].value=qSum; t5In[4].value=qSum;

          t5In[5].value=t3In[13].value; t5In[6].value=t3In[14].value; t5In[7].value=t3In[15].value;

          let fcSum=0; for(let j=2;j<=36;j++){const v=parseFloat(t4In[j].value); if(!isNaN(v)) fcSum+=v;}
          t4In[37].value=fcSum; t5In[8].value=fcSum;
        };

        [t1In, t2In, t3In, t4In].forEach(set => set.forEach(input => input.addEventListener("input", recalc)));
      });
    }

    function saveAll() {
      const getRows = tbody => [...tbody.querySelectorAll("tr")].map(tr => [...tr.querySelectorAll("input.cell")].map(x=>x.value.replace(/,/g," ")));
      const data = {
        leader: leader.value.trim(), section: section.value.trim(), group: group.value.trim(),
        table1: getRows(table1Tbody), table1Headers: [...table1HeadInputs].map(x=>x.value.replace(/,/g," ")),
        table2: getRows(table2Tbody), table2Headers: [...table2HeadInputs].map(x=>x.value.replace(/,/g," ")),
        table3: getRows(table3Tbody), table3Headers: [...table3HeadInputs].map(x=>x.value.replace(/,/g," ")),
        table4: getRows(table4Tbody), table5: getRows(table5Tbody)
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      showStatus("Saved");
      syncToGoogleSheets();
    }

    function showStatus(msg){ 
      const s = document.getElementById("status");
      s.textContent=msg; s.style.opacity="1"; setTimeout(()=>{s.style.opacity="0";},1500); 
    }

    async function syncToGoogleSheets() {
      if (!classParam || !leaderParam || GOOGLE_SCRIPT_URL.includes('YOUR_SCRIPT')) return;
      const getRows = tbody => [...tbody.querySelectorAll("tr")].map(tr => [...tr.querySelectorAll("input.cell")].map(x=>x.value));
      const payload = {
        class: classParam, leader: leaderParam, leaderName: leader.value, section: section.value, groupNumber: group.value,
        table1: getRows(table1Tbody), table1Headers: [...table1HeadInputs].map(x=>x.value),
        table2: getRows(table2Tbody), table2Headers: [...table2HeadInputs].map(x=>x.value),
        table3: getRows(table3Tbody), table3Headers: [...table3HeadInputs].map(x=>x.value),
        table4: getRows(table4Tbody), table5: getRows(table5Tbody).filter(r => r[0] || r[1])
      };
      try {
        await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        showStatus("Saved & Synced!");
      } catch (e) { showStatus("Saved (sync failed)"); }
    }

    document.getElementById("saveBtn").onclick = saveAll;
    document.getElementById("syncBtn").onclick = saveAll;
    document.getElementById("clearAllBtn").onclick = () => { if(confirm("Clear all?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); }};
    
    initialLoad();
  </script>
</body>
</html>
